name: ML Model CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-predictor

jobs:
  train:
    name: Train Model (CI)
    runs-on: ubuntu-latest
    
    outputs:
      r2_score: ${{ steps.metrics.outputs.r2 }}
      mse_score: ${{ steps.metrics.outputs.mse }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Train model
        run: python scripts/train.py
      
      - name: Extract metrics
        id: metrics
        run: |
          R2=$(python -c "import json; print(json.load(open('output/metrics.json'))['r2'])")
          MSE=$(python -c "import json; print(json.load(open('output/metrics.json'))['mse'])")
          echo "r2=$R2" >> $GITHUB_OUTPUT
          echo "mse=$MSE" >> $GITHUB_OUTPUT
          echo "üìä Model Metrics:"
          echo "   R2 Score: $R2"
          echo "   MSE: $MSE"
      
      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            output/model.pkl
            output/metrics.json
          retention-days: 30

  deploy:
    name: Deploy Model (CD)
    runs-on: ubuntu-latest
    needs: train
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: output
      
      - name: Compare metrics with baseline
        id: compare
        run: |
          CURRENT_R2=${{ needs.train.outputs.r2_score }}
          BEST_R2=${{ vars.BEST_R2 }}
          
          # Default to 0 if BEST_R2 is not set
          if [ -z "$BEST_R2" ]; then
            BEST_R2=0
          fi
          
          echo "Current R2: $CURRENT_R2"
          echo "Best R2: $BEST_R2"
          
          # Compare using Python for proper float comparison
          IMPROVED=$(python -c "print('true' if $CURRENT_R2 > $BEST_R2 else 'false')")
          echo "improved=$IMPROVED" >> $GITHUB_OUTPUT
          
          if [ "$IMPROVED" = "false" ]; then
            echo "2022BCS0015----Metric did not improve"
            echo "Current R2 ($CURRENT_R2) is not better than Best R2 ($BEST_R2)"
          else
            echo "‚úÖ Model improved! Proceeding with deployment..."
          fi
      
      - name: Login to Docker Hub
        if: steps.compare.outputs.improved == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build Docker image
        if: steps.compare.outputs.improved == 'true'
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:latest .
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.run_number }} .
      
      - name: Push Docker image
        if: steps.compare.outputs.improved == 'true'
        run: |
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.run_number }}
          echo "üöÄ Image pushed to Docker Hub: ${{ env.DOCKER_IMAGE }}"
      
      - name: Update baseline metrics
        if: steps.compare.outputs.improved == 'true'
        run: |
          echo "üìà New baseline R2: ${{ needs.train.outputs.r2_score }}"
          echo "üìà New baseline MSE: ${{ needs.train.outputs.mse_score }}"
          echo ""
          echo "‚ö†Ô∏è  Please update GitHub Variables manually:"
          echo "    BEST_R2 = ${{ needs.train.outputs.r2_score }}"
          echo "    BEST_MSE = ${{ needs.train.outputs.mse_score }}"
